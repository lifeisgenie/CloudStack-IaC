apiVersion: apps/v1
kind: Deployment
metadata:
  name: registry
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: registry
  template:
    metadata:
      labels:
        app: registry
    spec:
      volumes:
        - name: registry-data
          persistentVolumeClaim:
            claimName: registry-pvc
        - name: certs
          emptyDir: {}
      initContainers:
        - name: generate-certs
          image: alpine:3.20
          command: ["/bin/sh", "-c"]
          args:
            - |
              apk add --no-cache openssl
              mkdir -p /certs
              openssl req -x509 -nodes -days 365 \
                -newkey rsa:2048 \
                -keyout /certs/tls.key \
                -out /certs/tls.crt \
                -subj "/CN=registry.local"
          volumeMounts:
            - name: certs
              mountPath: /certs
      containers:
        - name: registry
          image: registry:2
          ports:
            - containerPort: 5000
          env:
            - name: REGISTRY_HTTP_TLS_CERTIFICATE
              value: /certs/tls.crt
            - name: REGISTRY_HTTP_TLS_KEY
              value: /certs/tls.key
          volumeMounts:
            - name: registry-data
              mountPath: /var/lib/registry
            - name: certs
              mountPath: /certs
              readOnly: true